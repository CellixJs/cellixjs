trigger:
 paths:
   include:
     - packages/**
     - apps/**
   exclude:
     - packages/**/coverage/**
     - packages/**/dist/**
     - apps/**/dist/**
     - apps/**/build/**
     - apps/**/.next/**
     - apps/**/node_modules/**
 branches:
   include:
     - main

pr:
  branches:
    include:
     - main

pool:
  vmImage: ubuntu-latest

variables:
  - group: github-credential-cellixjs
  deploymentDefaultLocation: 'eastus2'
  ServiceConnectionName: 'ShareThrift-MSDN'
  vmImageName: 'ubuntu-latest'
  system.debug: true
  npm_config_cache: $(Pipeline.Workspace)/.npm
  SONAR_USER_HOME: $(Pipeline.Workspace)/.sonar

stages:
  - template: ./build-pipeline/core/monorepo-build-stage.yml
    parameters:
      vmImageName: $(vmImageName)
      npm_config_cache: $(npm_config_cache)
      isNpmCacheAvailable: 'true'
      disableSonarCloudTasks: 'false'
      SONAR_USER_HOME: $(SONAR_USER_HOME)
      SonarCloud: 'sonarcloud'
      SonarCloud_organization: 'simnova'
      SonarCloud_scannerMode: 'CLI'
      SonarCloud_configMode: 'manual'
      SonarCloud_cliProjectKey: 'simnova_cellix-data-access'
      SonarCloud_cliProjectName: 'cellix-data-access'

  - template: ./build-pipeline/core/monorepo-deployment-stage.yml
    parameters:
      stageName: 'DEV'
      environmentNameBicep: 'dev'
      environmentNameDevOps: 'cellix-dev'
      vmImageName: $(vmImageName)
      ServiceConnectionName: $(ServiceConnectionName)
      deploymentDefaultLocation: $(deploymentDefaultLocation)
      resourceGroupName: 'rg-sharethrift'